<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vedic Astrocartography</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        .header {
            margin-bottom: 20px;
        }

        .form-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }

        .map-container {
            flex: 1;
            position: relative;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
        }

        #map {
            height: 100%;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 10px;
            margin-right: 10px;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .error-message {
            color: #ff0000;
            font-weight: bold;
            margin-bottom: 10px;
        }

        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        .planet-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .planet-checkbox {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Vedic Astrocartography Map</h1>
            <p>Enter your birth details to see your astrocartography map</p>
        </div>

        <div class="form-container">
            <div class="form-group">
                <label for="year">Birth Year</label>
                <input type="number" id="year" value="1990">
            </div>
            <div class="form-group">
                <label for="month">Birth Month</label>
                <input type="number" id="month" min="1" max="12" value="1">
            </div>
            <div class="form-group">
                <label for="day">Birth Day</label>
                <input type="number" id="day" min="1" max="31" value="1">
            </div>
            <div class="form-group">
                <label for="hour">Birth Hour</label>
                <input type="number" id="hour" min="0" max="23" value="12">
            </div>
            <div class="form-group">
                <label for="minute">Birth Minute</label>
                <input type="number" id="minute" min="0" max="59" value="0">
            </div>
            <div class="form-group">
                <label for="second">Birth Second</label>
                <input type="number" id="second" min="0" max="59" value="0">
            </div>
            <div class="form-group">
                <label for="latitude">Birth Latitude</label>
                <input type="number" id="latitude" step="0.000001" value="28.6139">
            </div>
            <div class="form-group">
                <label for="longitude">Birth Longitude</label>
                <input type="number" id="longitude" step="0.000001" value="77.2090">
            </div>
            <div class="form-group">
                <label for="utc">UTC Offset</label>
                <input type="text" id="utc" value="+05:30">
            </div>
            <div class="form-group">
                <label for="ayanamsa">Ayanamsa</label>
                <select id="ayanamsa">
                    <option value="Krishnamurti">Krishnamurti</option>
                    <option value="Lahiri">Lahiri</option>
                    <option value="Raman">Raman</option>
                </select>
            </div>
        </div>

        <div class="planet-selector">
            <div class="planet-checkbox">
                <input type="checkbox" id="Sun" checked>
                <label for="Sun">Sun</label>
            </div>
            <div class="planet-checkbox">
                <input type="checkbox" id="Moon" checked>
                <label for="Moon">Moon</label>
            </div>
            <div class="planet-checkbox">
                <input type="checkbox" id="Mercury" checked>
                <label for="Mercury">Mercury</label>
            </div>
            <div class="planet-checkbox">
                <input type="checkbox" id="Venus" checked>
                <label for="Venus">Venus</label>
            </div>
            <div class="planet-checkbox">
                <input type="checkbox" id="Mars" checked>
                <label for="Mars">Mars</label>
            </div>
            <div class="planet-checkbox">
                <input type="checkbox" id="Jupiter" checked>
                <label for="Jupiter">Jupiter</label>
            </div>
            <div class="planet-checkbox">
                <input type="checkbox" id="Saturn" checked>
                <label for="Saturn">Saturn</label>
            </div>
            <div class="planet-checkbox">
                <input type="checkbox" id="Rahu">
                <label for="Rahu">Rahu</label>
            </div>
            <div class="planet-checkbox">
                <input type="checkbox" id="Ketu">
                <label for="Ketu">Ketu</label>
            </div>
        </div>

        <div class="buttons">
            <button id="generateMap">Generate Astrocartography Map</button>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="map-container">
            <div id="map"></div>
            <div class="legend">
                <h3>Line Types</h3>
                <div id="lineLegend"></div>
                <h3>Planets</h3>
                <div id="planetLegend"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize the map
        const map = L.map('map').setView([0, 0], 2);

        // Add a tile layer (you can choose different styles)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Store map layers by planet and line type
        let mapLayers = {};

        // Define line types and colors (must match backend)
        const lineTypes = {
            "Ascendant": { abbreviation: "AS", color: "#FF0000" },
            "Midheaven": { abbreviation: "MC", color: "#0000FF" },
            "Descendant": { abbreviation: "DS", color: "#FF8800" },
            "Imum Coeli": { abbreviation: "IC", color: "#00FF00" }
        };

        // Generate line type legend
        const lineLegend = document.getElementById('lineLegend');
        for (const [type, info] of Object.entries(lineTypes)) {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';

            const colorBox = document.createElement('div');
            colorBox.className = 'legend-color';
            colorBox.style.backgroundColor = info.color;

            const label = document.createElement('span');
            label.innerText = `${type} (${info.abbreviation})`;

            legendItem.appendChild(colorBox);
            legendItem.appendChild(label);
            lineLegend.appendChild(legendItem);
        }

        // Planet colors for legend
        const planetColors = {
            "Sun": "#FFA500",
            "Moon": "#SILVER",
            "Mercury": "#9932CC",
            "Venus": "#FF69B4",
            "Mars": "#FF0000",
            "Jupiter": "#DAA520",
            "Saturn": "#708090",
            "Rahu": "#000080",
            "Ketu": "#800000"
        };

        // Generate planet legend
        const planetLegend = document.getElementById('planetLegend');
        for (const [planet, color] of Object.entries(planetColors)) {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';

            const colorBox = document.createElement('div');
            colorBox.className = 'legend-color';
            colorBox.style.backgroundColor = color;

            const label = document.createElement('span');
            label.innerText = planet;

            legendItem.appendChild(colorBox);
            legendItem.appendChild(label);
            planetLegend.appendChild(legendItem);
        }

        // Function to clear existing layers
        function clearMap() {
            for (const planetName in mapLayers) {
                for (const lineType in mapLayers[planetName]) {
                    map.removeLayer(mapLayers[planetName][lineType]);
                }
            }
            mapLayers = {};
        }

        // Function to generate the map
        async function generateMap() {
            try {
                // Clear existing layers and error message
                clearMap();
                document.getElementById('errorMessage').textContent = '';

                // Get selected planets
                const selectedPlanets = [];
                document.querySelectorAll('.planet-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedPlanets.push(checkbox.id);
                });

                if (selectedPlanets.length === 0) {
                    alert('Please select at least one planet.');
                    return;
                }

                // Show loading message
                document.getElementById('errorMessage').textContent = 'Generating map, please wait...';

                // Get form values
                const formData = {
                    year: parseInt(document.getElementById('year').value),
                    month: parseInt(document.getElementById('month').value),
                    day: parseInt(document.getElementById('day').value),
                    hour: parseInt(document.getElementById('hour').value),
                    minute: parseInt(document.getElementById('minute').value),
                    second: parseInt(document.getElementById('second').value),
                    latitude: parseFloat(document.getElementById('latitude').value),
                    longitude: parseFloat(document.getElementById('longitude').value),
                    utc: document.getElementById('utc').value,
                    ayanamsa: document.getElementById('ayanamsa').value,
                    house_system: "Placidus",
                    planets: selectedPlanets
                };

                console.log('Sending request with data:', JSON.stringify(formData));

                // Call the API
                const response = await fetch('http://localhost:8000/get_astrocartography_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                // Clear loading message
                document.getElementById('errorMessage').textContent = '';

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API response error:', errorText);
                    throw new Error(`Server responded with status ${response.status}: ${errorText}`);
                }

                const data = await response.json();

                if (data.status !== 'success') {
                    throw new Error(data.message || 'Failed to generate astrocartography map');
                }

                // Add birthplace marker
                L.marker([data.birthLocation.latitude, data.birthLocation.longitude])
                    .addTo(map)
                    .bindPopup('Birth Location')
                    .openPopup();

                // Draw lines on the map
                data.lines.forEach(line => {
                    // If this is the first time seeing this planet, initialize its object in mapLayers
                    if (!mapLayers[line.planet]) {
                        mapLayers[line.planet] = {};
                    }

                    // Convert coordinates from [lat, lon] format to Leaflet's [[lat, lon], ...] format
                    const latLngs = line.coordinates.map(coord => [coord[0], coord[1]]);

                    // Create polyline with the appropriate color
                    const polyline = L.polyline(latLngs, {
                        color: line.color,
                        weight: 2,
                        opacity: 0.8
                    }).addTo(map);

                    // Add popup with information
                    polyline.bindPopup(`${line.planet} ${line.lineType} Line ${line.isRetrograde ? '(Retrograde)' : ''}`);

                    // Store the layer for later reference
                    mapLayers[line.planet][line.lineType] = polyline;
                });

                // Center the map on the birth location
                map.setView([data.birthLocation.latitude, data.birthLocation.longitude], 2);

            } catch (error) {
                console.error('Error generating map:', error);
                alert('Error generating map: ' + error.message);
            }
        }

        // Add event listener to the generate button
        document.getElementById('generateMap').addEventListener('click', generateMap);
    </script>
</body>
</html>
